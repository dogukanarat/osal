name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.compiler }}-${{ matrix.library_type }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        library_type: [static, shared]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++

    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
      BUILD_TYPE: Debug

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            clang \
            clang-format \
            clang-tidy \
            build-essential

      - name: Cache CMake build
        uses: actions/cache@v3
        with:
          path: build
          key: cmake-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.library_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            cmake-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.library_type }}-
            cmake-${{ runner.os }}-${{ matrix.compiler }}-

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=ON \
            -DBUILD_SHARED_LIBS=${{ matrix.library_type == 'shared' && 'ON' || 'OFF' }} \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel $(nproc)

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.compiler }}-${{ matrix.library_type }}
          path: build/Testing/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: libscaffold-${{ matrix.compiler }}-${{ matrix.library_type }}
          path: |
            build/liblibscaffold.*
            build/test/test_libscaffold
